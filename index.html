<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجز مواعيد - PhysioCare</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --border-radius: 8px;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        .logo {
            max-width: 250px;
            margin-bottom: 15px;
        }
        header h1 { color: var(--primary-color); margin: 0; }
        .branch-selector {
            margin-bottom: 30px;
        }
        .branch-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: var(--dark-gray);
        }
        #branchSelect {
            width: 100%;
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 1.1rem;
            font-family: 'Cairo', sans-serif;
        }
        #loader, #doctors-placeholder {
            text-align: center;
            font-size: 1.2rem;
            padding: 40px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        .doctor-card {
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            padding: 20px;
        }
        .doctor-info { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .doctor-info img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); }
        .doctor-details h2 { margin: 0; font-size: 1.5rem; }
        .doctor-details p { margin: 0; color: var(--secondary-color); }
        .appointments h3 { font-size: 1.1rem; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-top: 15px; }
        .slots-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .slot { padding: 10px; border-radius: 5px; text-align: center; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .slot.available { background-color: var(--success-color); color: #fff; }
        .slot.available:hover { transform: translateY(-2px); background-color: #218838; }
        .slot.booked { background-color: #e0e0e0; color: #888; cursor: not-allowed; text-decoration: line-through; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: var(--border-radius); position: relative; }
        .close-btn { color: #aaa; position: absolute; left: 20px; top: 10px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-form h2 { margin-top: 0; color: var(--primary-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 12px; border: none; border-radius: 5px; background-color: var(--primary-color); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <img src="image.png" alt="PhysioCare Logo" class="logo">
        </header>

        <div class="branch-selector">
            <label for="branchSelect">الخطوة الأولى: اختر الفرع</label>
            <select id="branchSelect">
                <option value="">-- يرجى اختيار الفرع --</option>
            </select>
        </div>

        <main id="doctors-container">
            <div id="doctors-placeholder">الرجاء اختيار فرع لعرض الأطباء والمواعيد المتاحة.</div>
        </main>
        <div id="loader" style="display: none;">جاري تحميل البيانات...</div>
    </div>

    <div id="bookingModal" class="modal">...</div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ‼️ سنقوم بنقل هذه البيانات إلى Firestore لاحقاً ---
        // --- ‼️ For now, we put the data here for testing ---
        const branches = [
            { id: "eden_mall", name: "فرع ايدن مول - الشيخ زايد" },
            { id: "arkan_mall", name: "فرع اركان مول - الشيخ زايد" },
            { id: "mohandessin", name: "فرع المهندسين" },
            { id: "maadi", name: "فرع المعادي" },
            { id: "tagamoa", name: "فرع التجمع الخامس" }
        ];

        const doctors = [
            // --- أطباء فرع ايدن مول ---
            { name: "د. محمد صادق", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] }, // سبت، اثنين، اربعاء - مسائي
            { name: "د. محمد سعيد", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            { name: "د. محمد سيف", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            { name: "د. مارتن هاني", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            { name: "د. نيره خالد", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            { name: "د. همسه محمد", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            { name: "د. فريد السعدني", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            { name: "د. يارا امجد", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            { name: "د. ميرنا محمد", branchId: "eden_mall", shiftType: "evening", days: [6, 1, 3] },
            
            // ‼️ افترضت مؤقتاً أن هذا الشيفت صباحي
            { name: "د. ياسمين احمد", branchId: "eden_mall", shiftType: "morning", days: [0, 2, 4] }, // أحد، ثلاثاء،خميس - صباحي
            { name: "د. غاده بسيوني", branchId: "eden_mall", shiftType: "morning", days: [0, 2, 4] },
            { name: "د. مها نبيل", branchId: "eden_mall", shiftType: "morning", days: [0, 2, 4] },
            { name: "د. اسراء جمال", branchId: "eden_mall", shiftType: "morning", days: [0, 2, 4] },
            { name: "د. محمد سعيد", branchId: "eden_mall", shiftType: "morning", days: [0, 2, 4] }, // يعمل هنا ايضا
            { name: "د. محمد صادق", branchId: "eden_mall", shiftType: "morning", days: [0, 2, 4] }, // يعمل هنا ايضا
            { name: "د. اسماء مصطفي", branchId: "eden_mall", shiftType: "morning", days: [0, 2, 4] },
        ];
        // --- نهاية البيانات المؤقتة ---

        const branchSelect = document.getElementById('branchSelect');
        const doctorsContainer = document.getElementById('doctors-container');
        const doctorsPlaceholder = document.getElementById('doctors-placeholder');
        const loader = document.getElementById('loader');

        // Populate branch dropdown
        branches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = branch.name;
            branchSelect.appendChild(option);
        });

        // Listen for branch selection
        branchSelect.addEventListener('change', (e) => {
            const selectedBranchId = e.target.value;
            if (selectedBranchId) {
                displaySchedulesForBranch(selectedBranchId);
            } else {
                doctorsContainer.innerHTML = '';
                doctorsPlaceholder.style.display = 'block';
                doctorsPlaceholder.textContent = 'الرجاء اختيار فرع لعرض الأطباء والمواعيد المتاحة.';
            }
        });

        async function displaySchedulesForBranch(branchId) {
            loader.style.display = 'block';
            doctorsContainer.innerHTML = '';
            doctorsPlaceholder.style.display = 'none';

            const doctorsInBranch = doctors.filter(d => d.branchId === branchId);

            if (doctorsInBranch.length === 0) {
                loader.style.display = 'none';
                doctorsContainer.innerHTML = `<div id="doctors-placeholder">سيتم إضافة الأطباء والمواعيد لهذا الفرع قريباً.</div>`;
                return;
            }

            // In a real app, you would fetch bookings from Firestore here
            // const allBookedSlots = await fetchAllBookings();
            
            // For now, we simulate fetching bookings
            await new Promise(resolve => setTimeout(resolve, 500)); // Simulate network delay

            const uniqueDoctorNames = [...new Set(doctorsInBranch.map(d => d.name))];

            uniqueDoctorNames.forEach(doctorName => {
                const doctorAssignments = doctorsInBranch.filter(d => d.name === doctorName);
                const doctorCard = document.createElement('div');
                doctorCard.className = 'doctor-card';

                let doctorHTML = `
                    <div class="doctor-info">
                        <img src="https://ui-avatars.com/api/?name=${doctorName.replace(' ', '+')}&background=007bff&color=fff&size=128" alt="${doctorName}">
                        <div class="doctor-details">
                            <h2>${doctorName}</h2>
                            <p>أخصائي علاج طبيعي</p>
                        </div>
                    </div>
                    <div class="appointments">`;
                
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() + i);
                    const dayOfWeek = date.getDay();

                    doctorAssignments.forEach(assignment => {
                        if (assignment.days.includes(dayOfWeek)) {
                            const timeSlots = generateTimeSlots(assignment.shiftType);
                            const dateString = date.toISOString().split('T')[0];
                            const dayName = new Intl.DateTimeFormat('ar-EG', { weekday: 'long' }).format(date);
                            
                            doctorHTML += `<h3>${dayName} - ${dateString} (${assignment.shiftType === 'morning' ? 'صباحي' : 'مسائي'})</h3>`;
                            doctorHTML += `<div class="slots-container">`;
                            timeSlots.forEach(slot => {
                                // Here you would check against fetched bookings
                                doctorHTML += `<div class="slot available" data-date="${dateString}" data-time="${slot}">${slot}</div>`;
                            });
                            doctorHTML += `</div>`;
                        }
                    });
                }

                doctorHTML += `</div>`;
                doctorCard.innerHTML = doctorHTML;
                doctorsContainer.appendChild(doctorCard);
            });

            loader.style.display = 'none';
        }

        function generateTimeSlots(shiftType) {
            const slots = [];
            let startTime = (shiftType === 'morning') ? (10 * 60 + 30) : (16 * 60 + 30);
            for (let i = 0; i < 9; i++) {
                const totalMinutes = startTime + (i * 40);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                slots.push(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`);
            }
            return slots;
        }

    </script>
</body>
</html>
