<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="احجز جلسة العلاج الطبيعي في PhysioCare - أفضل مراكز العلاج الطبيعي في مصر" />
  <meta name="keywords" content="علاج طبيعي, حجز جلسة, PhysioCare, العلاج الطبيعي, مصر" />
  <meta name="author" content="PhysioCare" />
  <meta name="robots" content="index, follow" />
  <meta property="og:title" content="PhysioCare - حجز جلسة علاج طبيعي" />
  <meta property="og:description" content="احجز جلستك العلاجية بسهولة وأمان مع أفضل أطباء العلاج الطبيعي" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://physiocare.com" />
  <meta property="og:image" content="https://physiocare.com/images/logo.png" />
  <meta name="twitter:card" content="summary_large_image" />
  
  <title>PhysioCare | حجز جلسة علاج طبيعي</title>
  
  <!-- Preconnect to external domains for performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://cdn-icons-png.flaticon.com">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  
  <style>
    /* CSS Custom Properties for better maintainability */
    :root {
      --primary-color: #005f73;
      --primary-light: #0a9396;
      --secondary-color: #009688;
      --secondary-light: #1cc7a8;
      --accent-color: #94d2bd;
      --success-color: #28a745;
      --error-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-bg: #f8f9fa;
      --white: #ffffff;
      --dark-text: #343a40;
      --gray-text: #6c757d;
      --border-color: #ced4da;
      --border-light: #e9ecef;
      --shadow-light: 0 2px 4px rgba(0,0,0,0.04);
      --shadow-medium: 0 4px 8px rgba(0,0,0,0.08);
      --shadow-heavy: 0 10px 30px rgba(0,0,0,0.08);
      --border-radius: 8px;
      --border-radius-large: 16px;
      --transition: all 0.3s ease;
      --font-family: 'Cairo', sans-serif;
      --max-width: 800px;
    }

    /* Reset and base styles */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      background-color: var(--light-bg);
      color: var(--dark-text);
      direction: rtl;
      line-height: 1.6;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--primary-color);
      color: var(--white);
      padding: 8px;
      text-decoration: none;
      border-radius: var(--border-radius);
      z-index: 1000;
    }

    .skip-link:focus {
      top: 6px;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      padding: 40px 20px;
      text-align: center;
      color: var(--white);
      box-shadow: var(--shadow-heavy);
      border-bottom: 4px solid var(--accent-color);
      position: relative;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      opacity: 0.1;
      pointer-events: none;
    }

    header h1 {
      margin: 0;
      font-size: clamp(2rem, 5vw, 2.8rem);
      font-weight: 800;
      letter-spacing: 1px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      position: relative;
      z-index: 1;
    }

    header p {
      margin: 10px 0 0;
      font-size: clamp(1rem, 3vw, 1.2rem);
      font-weight: 400;
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }

    /* Main Container */
    .container {
      max-width: var(--max-width);
      background: var(--white);
      margin: 50px auto;
      padding: 40px;
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-heavy);
      border-top: 5px solid var(--secondary-color);
      position: relative;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }

    /* Typography */
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 700;
    }

    h3 {
      text-align: center;
      color: var(--primary-color);
      margin-top: 40px;
      margin-bottom: 20px;
      border-top: 1px solid var(--border-light);
      padding-top: 30px;
      font-size: clamp(1.2rem, 3vw, 1.5rem);
      font-weight: 600;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 25px;
      position: relative;
    }

    label {
      display: block;
      margin: 0 0 8px;
      font-weight: 700;
      color: var(--gray-text);
      font-size: 1.1rem;
      cursor: pointer;
    }

    .required::after {
      content: ' *';
      color: var(--error-color);
      font-weight: bold;
    }

    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="date"],
    textarea,
    select {
      width: 100%;
      padding: 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-family: var(--font-family);
      background-color: #fdfdff;
      transition: var(--transition);
      box-sizing: border-box;
      outline: none;
    }

    input[type="text"]:focus,
    input[type="tel"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    textarea:focus,
    select:focus {
      border-color: #007BFF;
      background-color: var(--white);
      box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
      transform: translateY(-1px);
    }

    /* Input validation styles */
    input.invalid,
    textarea.invalid,
    select.invalid {
      border-color: var(--error-color);
      background-color: #fff5f5;
      animation: shake 0.5s ease-in-out;
    }

    input.valid,
    textarea.valid,
    select.valid {
      border-color: var(--success-color);
      background-color: #f8fff8;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .error-message {
      color: var(--error-color);
      font-size: 0.9rem;
      margin-top: 5px;
      display: none;
      font-weight: 600;
      animation: fadeIn 0.3s ease-in-out;
    }

    .success-message {
      color: var(--success-color);
      font-size: 0.9rem;
      margin-top: 5px;
      display: none;
      font-weight: 600;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    /* Choice Buttons */
    .choice-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 12px;
      margin: 10px 0 25px;
    }

    .choice-button {
      padding: 12px 25px;
      border: 2px solid var(--border-light);
      background: var(--light-bg);
      color: var(--gray-text);
      font-size: 1rem;
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 700;
      box-shadow: var(--shadow-light);
      position: relative;
      overflow: hidden;
      min-width: 120px;
      text-align: center;
    }

    .choice-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s;
    }

    .choice-button:hover::before {
      left: 100%;
    }

    .choice-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
      border-color: #007BFF;
      color: #007BFF;
    }

    .choice-button:focus {
      outline: 2px solid #007BFF;
      outline-offset: 2px;
    }

    .choice-button.active {
      background: linear-gradient(135deg, #007BFF, #0056b3);
      color: var(--white);
      border-color: #0056b3;
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
      transform: translateY(-2px);
    }

    .choice-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* File Upload Section */
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .file-box {
      position: relative;
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      background-color: #fdfdfd;
      transition: var(--transition);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 140px;
      overflow: hidden;
    }

    .file-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0,123,255,0.05) 50%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .file-box:hover::before {
      opacity: 1;
    }

    .file-box:hover {
      border-color: #007BFF;
      background-color: #f8faff;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
    }

    .file-box:focus-within {
      outline: 2px solid #007BFF;
      outline-offset: 2px;
    }

    .file-box label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--gray-text);
      margin: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

    .file-box .icon, 
    .file-box img {
      font-size: 2.5rem;
      line-height: 1;
      filter: grayscale(50%);
      transition: var(--transition);
    }

    .file-box:hover .icon, 
    .file-box:hover img {
      filter: grayscale(0%);
      transform: scale(1.1);
    }

    .file-box img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .file-box input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      z-index: 1;
    }

    .file-box.has-file {
      border-color: var(--success-color);
      background-color: #f8fff8;
      border-style: solid;
    }

    .file-box.has-file .icon {
      color: var(--success-color);
    }

    .file-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: var(--success-color);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 0 0 12px 12px;
    }

    /* Submit Button */
    .submit-container {
      margin-top: 40px;
      text-align: center;
    }

    button[type="submit"] {
      background: linear-gradient(135deg, var(--secondary-light) 0%, var(--secondary-color) 100%);
      color: var(--white);
      border: none;
      padding: 18px 40px;
      width: 100%;
      max-width: 400px;
      font-size: 1.2rem;
      font-weight: 700;
      font-family: var(--font-family);
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 5px 20px rgba(0, 150, 136, 0.3);
      position: relative;
      overflow: hidden;
    }

    button[type="submit"]::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.6s;
    }

    button[type="submit"]:hover:not(:disabled)::before {
      left: 100%;
    }

    button[type="submit"]:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(0, 150, 136, 0.4);
    }

    button[type="submit"]:focus {
      outline: 3px solid rgba(0, 150, 136, 0.5);
      outline-offset: 2px;
    }

    button[type="submit"]:disabled {
      background: #ccc;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
      opacity: 0.7;
    }

    /* Evening Options Wrapper */
    #evening-options {
      background: var(--light-bg);
      padding: 25px;
      margin-top: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-light);
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 500px;
      }
    }

    /* Message Notifications */
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      z-index: 1000;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideInRight 0.3s ease-out;
      max-width: 350px;
      min-width: 250px;
      backdrop-filter: blur(10px);
    }

    .message.success {
      background: rgba(212, 237, 218, 0.95);
      color: #155724;
      border: 1px solid #c3e6cb;
      border-left: 4px solid var(--success-color);
    }

    .message.error {
      background: rgba(248, 215, 218, 0.95);
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-left: 4px solid var(--error-color);
    }

    .message.info {
      background: rgba(209, 236, 241, 0.95);
      color: #0c5460;
      border: 1px solid #bee5eb;
      border-left: 4px solid var(--info-color);
    }

    .message.warning {
      background: rgba(255, 243, 205, 0.95);
      color: #856404;
      border: 1px solid #ffeaa7;
      border-left: 4px solid var(--warning-color);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border-light);
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary-color), var(--secondary-light));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 3px;
    }

    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: var(--white);
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.9rem;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Footer */
    footer {
      text-align: center;
      color: #888;
      margin: 50px 0 20px;
      font-size: 0.9rem;
      padding: 20px;
      border-top: 1px solid var(--border-light);
    }

    /* Accessibility improvements */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus indicators */
    *:focus {
      outline: 2px solid #007BFF;
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --border-color: #000;
        --gray-text: #000;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --light-bg: #1a1a1a;
        --white: #2d2d2d;
        --dark-text: #e0e0e0;
        --gray-text: #b0b0b0;
        --border-color: #404040;
        --border-light: #333;
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        margin: 20px;
        padding: 25px;
      }
      
      header {
        padding: 30px 15px;
      }
      
      .choice-group {
        flex-direction: column;
      }
      
      .choice-button {
        width: 100%;
        text-align: center;
        min-width: auto;
      }
      
      .file-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      
      .message {
        right: 10px;
        left: 10px;
        max-width: none;
      }

      button[type="submit"] {
        padding: 16px 30px;
        font-size: 1.1rem;
      }
    }

    @media (max-width: 480px) {
      .file-grid {
        grid-template-columns: 1fr;
      }
      
      header {
        padding: 20px 10px;
      }
      
      .container {
        margin: 10px;
        padding: 20px;
      }

      .choice-button {
        padding: 14px 20px;
        font-size: 0.95rem;
      }
    }

    /* Print styles */
    @media print {
      header {
        background: none !important;
        color: #000 !important;
        box-shadow: none !important;
      }
      
      .container {
        box-shadow: none !important;
        border: 1px solid #000 !important;
      }
      
      .choice-button {
        border: 1px solid #000 !important;
        background: none !important;
      }
      
      .message {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a href="#main-content" class="skip-link">انتقل إلى المحتوى الرئيسي</a>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loading-overlay" aria-hidden="true">
    <div class="loading-spinner"></div>
  </div>

  <header role="banner">
    <h1>PhysioCare</h1>
    <p>احجز جلستك العلاجية بسهولة وأمان</p>
  </header>

  <main id="main-content" role="main">
    <div class="container">
      <h2>نموذج حجز جلسة علاج طبيعي</h2>
      
      <!-- Progress bar -->
      <div class="progress-bar" aria-label="تقدم النموذج">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      
      <form id="booking-form" novalidate aria-label="نموذج حجز جلسة علاج طبيعي">
        <div class="form-group">
          <label for="name" class="required">الاسم الكامل</label>
          <input 
            type="text" 
            id="name" 
            name="name"
            required 
            placeholder="اكتب اسمك ثلاثي"
            aria-describedby="name-error name-help"
            autocomplete="name"
            minlength="6"
            maxlength="50"
          >
          <div class="error-message" id="name-error" role="alert" aria-live="polite"></div>
          <div class="success-message" id="name-success" role="status" aria-live="polite"></div>
          <div id="name-help" class="sr-only">يجب أن يكون الاسم ثلاثي على الأقل</div>
        </div>

        <div class="form-group">
          <label for="phone" class="required">رقم الهاتف</label>
          <input 
            type="tel" 
            id="phone" 
            name="phone"
            required 
            placeholder="01XXXXXXXXX"
            aria-describedby="phone-error phone-help"
            autocomplete="tel"
            pattern="^01[0-2,5]{1}[0-9]{8}$"
            maxlength="11"
          >
          <div class="error-message" id="phone-error" role="alert" aria-live="polite"></div>
          <div class="success-message" id="phone-success" role="status" aria-live="polite"></div>
          <div id="phone-help" class="sr-only">رقم الهاتف يجب أن يبدأ بـ 01 ويكون 11 رقم</div>
        </div>

        <div class="form-group">
          <label for="alt-phone">رقم هاتف احتياطي (اختياري)</label>
          <input 
            type="tel" 
            id="alt-phone" 
            name="alt-phone"
            placeholder="01XXXXXXXXX"
            aria-describedby="alt-phone-error"
            autocomplete="tel"
            pattern="^01[0-2,5]{1}[0-9]{8}$"
            maxlength="11"
          >
          <div class="error-message" id="alt-phone-error" role="alert" aria-live="polite"></div>
          <div class="success-message" id="alt-phone-success" role="status" aria-live="polite"></div>
        </div>

        <div class="form-group">
          <label class="required">شركة التأمين</label>
          <div class="choice-group" id="insurance-buttons" role="radiogroup" aria-label="اختر شركة التأمين">
            <button type="button" class="choice-button" data-value="Globmed" role="radio" aria-checked="false">Globmed</button>
            <button type="button" class="choice-button" data-value="CASH 💰" role="radio" aria-checked="false">CASH 💰</button>
            <button type="button" class="choice-button" data-value="NextCare" role="radio" aria-checked="false">NextCare</button>
            <button type="button" class="choice-button" data-value="AXA" role="radio" aria-checked="false">AXA</button>
            <button type="button" class="choice-button" data-value="Metlife (Alico)" role="radio" aria-checked="false">Metlife (Alico)</button>
            <button type="button" class="choice-button" data-value="MedRight" role="radio" aria-checked="false">MedRight</button>
            <button type="button" class="choice-button" data-value="Enppi" role="radio" aria-checked="false">Enppi</button>
            <button type="button" class="choice-button" data-value="Bupa" role="radio" aria-checked="false">Bupa</button>
            <button type="button" class="choice-button" data-value="Egymed" role="radio" aria-checked="false">Egymed</button>
            <button type="button" class="choice-button" data-value="LimilessCare" role="radio" aria-checked="false">LimilessCare</button>
          </div>
          <input type="hidden" id="insurance" name="insurance" required>
          <div class="error-message" id="insurance-error" role="alert" aria-live="polite"></div>
        </div>

        <div class="form-group">
          <label class="required">اختر الفرع</label>
          <div class="choice-group" id="branch-buttons" role="radiogroup" aria-label="اختر الفرع">
            <button type="button" class="choice-button" data-value="إيدن مول - الشيخ زايد" role="radio" aria-checked="false">إيدن مول</button>
            <button type="button" class="choice-button" data-value="أركان مول - الشيخ زايد" role="radio" aria-checked="false">أركان مول</button>
            <button type="button" class="choice-button" data-value="المعادي" role="radio" aria-checked="false">المعادي</button>
            <button type="button" class="choice-button" data-value="المهندسين" role="radio" aria-checked="false">المهندسين</button>
            <button type="button" class="choice-button" data-value="التجمع الخامس" role="radio" aria-checked="false">التجمع</button>
          </div>
          <input type="hidden" id="branch" name="branch" required>
          <div class="error-message" id="branch-error" role="alert" aria-live="polite"></div>
        </div>

        <div class="form-group">
          <label for="date" class="required">التاريخ</label>
          <input 
            type="date" 
            id="date" 
            name="date"
            required
            aria-describedby="date-error date-help"
          >
          <div class="error-message" id="date-error" role="alert" aria-live="polite"></div>
          <div class="success-message" id="date-success" role="status" aria-live="polite"></div>
          <div id="date-help" class="sr-only">اختر تاريخ من الغد حتى شهرين قادمين</div>
        </div>

        <div class="form-group">
          <label class="required">اختيار الشيفت</label>
          <div class="choice-group" id="shift-buttons" role="radiogroup" aria-label="اختر الشيفت">
            <button type="button" class="choice-button" data-value="صباحي" role="radio" aria-checked="false">صباحي</button>
            <button type="button" class="choice-button" data-value="مسائي" role="radio" aria-checked="false">مسائي</button>
          </div>
          <input type="hidden" id="shift" name="shift" required>
          <div class="error-message" id="shift-error" role="alert" aria-live="polite"></div>
        </div>

        <div id="evening-options" style="display:none" aria-live="polite">
          <div class="form-group">
            <label for="doctors">اسم الدكتور الذي تريده</label>
            <input 
              type="text" 
              id="doctors" 
              name="doctors"
              placeholder="مثال: محمد صادق، نيره خالد"
              autocomplete="off"
              maxlength="100"
            >
          </div>
          
          <div class="form-group">
            <label>اختيار المواعيد</label>
            <div class="choice-group" id="time-buttons" role="group" aria-label="اختر الموعد">
              <button type="button" class="choice-button" data-value="4:30 م">4:30 م</button>
              <button type="button" class="choice-button" data-value="5:10 م">5:10 م</button>
              <button type="button" class="choice-button" data-value="5:50 م">5:50 م</button>
              <button type="button" class="choice-button" data-value="6:30 م">6:30 م</button>
              <button type="button" class="choice-button" data-value="7:10 م">7:10 م</button>
              <button type="button" class="choice-button" data-value="7:50 م">7:50 م</button>
              <button type="button" class="choice-button" data-value="8:30 م">8:30 م</button>
              <button type="button" class="choice-button" data-value="9:10 م">9:10 م</button>
              <button type="button" class="choice-button" data-value="9:50 م">9:50 م</button>
            </div>
            <input type="hidden" id="selected-time" name="selected-time">
            <div class="error-message" id="time-error" role="alert" aria-live="polite"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="notes">ملاحظات إضافية</label>
          <textarea 
            id="notes" 
            name="notes"
            rows="4" 
            placeholder="إذا كان لديك أي تفاصيل أخرى ترغب في توضيحها..."
            maxlength="500"
            aria-describedby="notes-counter"
          ></textarea>
          <div id="notes-counter" class="character-counter">0/500 حرف</div>
        </div>

        <h3>رفع الملفات الطبية</h3>
        <p class="file-instructions">يمكنك رفع الملفات بصيغة PDF أو صور (JPG, PNG). الحد الأقصى لحجم الملف 5 ميجابايت.</p>
        
        <div class="file-grid">
          <div class="file-box">
            <label for="file-carnet">
              <span class="icon" aria-hidden="true">📛</span> 
              الكارنيه
            </label>
            <input 
              type="file" 
              id="file-carnet" 
              name="file-carnet"
              accept="image/*,.pdf"
              aria-describedby="carnet-help"
            >
            <div class="file-progress"></div>
            <div id="carnet-help" class="sr-only">رفع صورة الكارنيه</div>
          </div>
          
          <div class="file-box">
            <label for="file-id">
              <span class="icon" aria-hidden="true">🪪</span> 
              البطاقة
            </label>
            <input 
              type="file" 
              id="file-id" 
              name="file-id"
              accept="image/*,.pdf"
              aria-describedby="id-help"
            >
            <div class="file-progress"></div>
            <div id="id-help" class="sr-only">رفع صورة البطاقة الشخصية</div>
          </div>
          
          <div class="file-box">
            <label for="file-prescription">
              <span class="icon" aria-hidden="true">💊</span> 
              الروشتة
            </label>
            <input 
              type="file" 
              id="file-prescription" 
              name="file-prescription"
              accept="image/*,.pdf"
              aria-describedby="prescription-help"
            >
            <div class="file-progress"></div>
            <div id="prescription-help" class="sr-only">رفع صورة الروشتة الطبية</div>
          </div>
          
          <div class="file-box">
            <label for="file-approval">
              <span class="icon" aria-hidden="true">📝</span> 
              الموافقة
            </label>
            <input 
              type="file" 
              id="file-approval" 
              name="file-approval"
              accept="image/*,.pdf"
              aria-describedby="approval-help"
            >
            <div class="file-progress"></div>
            <div id="approval-help" class="sr-only">رفع موافقة شركة التأمين</div>
          </div>
          
          <div class="file-box">
            <label for="file-xray1">
              <img src="https://cdn-icons-png.flaticon.com/512/3649/3649466.png" alt="" aria-hidden="true">
              تقرير أشعة
            </label>
            <input 
              type="file" 
              id="file-xray1" 
              name="file-xray1"
              accept="image/*,.pdf"
              aria-describedby="xray-help"
            >
            <div class="file-progress"></div>
            <div id="xray-help" class="sr-only">رفع تقرير الأشعة</div>
          </div>
          
          <div class="file-box">
            <label for="file-medical">
              <span class="icon" aria-hidden="true">📄</span> 
              تقرير طبي
            </label>
            <input 
              type="file" 
              id="file-medical" 
              name="file-medical"
              accept="image/*,.pdf"
              aria-describedby="medical-help"
            >
            <div class="file-progress"></div>
            <div id="medical-help" class="sr-only">رفع التقرير الطبي</div>
          </div>
          
          <div class="file-box">
            <label for="file-other">
              <span class="icon" aria-hidden="true">📎</span> 
              أخرى
            </label>
            <input 
              type="file" 
              id="file-other" 
              name="file-other"
              accept="image/*,.pdf"
              aria-describedby="other-help"
            >
            <div class="file-progress"></div>
            <div id="other-help" class="sr-only">رفع ملفات أخرى</div>
          </div>
        </div>

        <div class="submit-container">
          <button type="submit" id="submit-btn">
            تأكيد و إرسال الحجز
          </button>
        </div>
      </form>
    </div>
  </main>

  <footer role="contentinfo">
    <p>جميع الحقوق محفوظة &copy; PhysioCare 2025</p>
    <p>للدعم الفني: <a href="tel:+201234567890">01234567890</a> | <a href="mailto:support@physiocare.com">support@physiocare.com</a></p>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // Enhanced JavaScript with better error handling and security
    (function() {
      'use strict';

      // Configuration (should be moved to environment variables in production)
      const CONFIG = {
        firebase: {
          apiKey: "AIzaSyA6_OACwpwaFSiX8jfsjS0_bt_EfIc4rhY",
          authDomain: "physiocare-booking.firebaseapp.com",
          projectId: "physiocare-booking",
          storageBucket: "physiocare-booking.firebasestorage.app",
          messagingSenderId: "815959251074",
          appId: "1:815959251074:web:cfd13396b4072b90ccbc9b",
          measurementId: "G-HBYJGQRVBB"
        },
        maxFileSize: 5 * 1024 * 1024, // 5MB
        allowedFileTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'],
        debounceDelay: 300,
        maxRetries: 3
      };

      // Initialize Firebase
      let db, storage;
      try {
        firebase.initializeApp(CONFIG.firebase);
        db = firebase.firestore();
        storage = firebase.storage();
        console.log('Firebase initialized successfully');
      } catch (error) {
        console.error('Firebase initialization failed:', error);
        showMessage('خطأ في تهيئة النظام. يرجى إعادة تحميل الصفحة.', 'error');
      }

      // State management
      const state = {
        isSubmitting: false,
        uploadProgress: {},
        formData: {},
        validationErrors: {}
      };

      // Utility Functions
      const utils = {
        debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        },

        sanitizeInput(input) {
          return input.trim().replace(/[<>]/g, '');
        },

        formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        generateUniqueId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        },

        async retry(fn, maxRetries = CONFIG.maxRetries) {
          for (let i = 0; i < maxRetries; i++) {
            try {
              return await fn();
            } catch (error) {
              if (i === maxRetries - 1) throw error;
              await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
            }
          }
        }
      };

      // Message system
      function showMessage(message, type = 'info', duration = 5000) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;
        messageDiv.setAttribute('role', type === 'error' ? 'alert' : 'status');
        messageDiv.setAttribute('aria-live', 'polite');
        
        document.body.appendChild(messageDiv);
        
        // Auto remove
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.style.animation = 'slideInRight 0.3s ease-out reverse';
            setTimeout(() => {
              if (messageDiv.parentNode) {
                messageDiv.remove();
              }
            }, 300);
          }
        }, duration);

        // Manual close on click
        messageDiv.addEventListener('click', () => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        });
      }

      // Validation functions
      const validators = {
        name(value) {
          const trimmed = value.trim();
          if (!trimmed) return 'الاسم مطلوب';
          if (trimmed.length < 6) return 'الاسم قصير جداً';
          if (trimmed.split(' ').length < 2) return 'يجب إدخال الاسم ثلاثي على الأقل';
          if (!/^[\u0600-\u06FF\s]+$/.test(trimmed)) return 'يجب أن يحتوي الاسم على أحرف عربية فقط';
          return null;
        },

        phone(value) {
          const trimmed = value.trim();
          if (!trimmed) return 'رقم الهاتف مطلوب';
          if (!/^01[0-2,5]{1}[0-9]{8}$/.test(trimmed)) {
            return 'رقم الهاتف غير صحيح. يجب أن يبدأ بـ 01 ويكون 11 رقم';
          }
          return null;
        },

        altPhone(value) {
          const trimmed = value.trim();
          if (!trimmed) return null; // Optional field
          return validators.phone(trimmed);
        },

        date(value) {
          if (!value) return 'التاريخ مطلوب';
          const selectedDate = new Date(value);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          if (selectedDate <= today) return 'لا يمكن حجز موعد في الماضي';
          
          const maxDate = new Date(today);
          maxDate.setMonth(today.getMonth() + 2);
          
          if (selectedDate > maxDate) return 'لا يمكن حجز موعد بعد شهرين من الآن';
          
          return null;
        },

        required(value, fieldName) {
          return value ? null : `${fieldName} مطلوب`;
        },

        file(file) {
          if (!file) return null; // Optional
          
          if (file.size > CONFIG.maxFileSize) {
            return `حجم الملف كبير جداً. الحد الأقصى ${utils.formatFileSize(CONFIG.maxFileSize)}`;
          }
          
          if (!CONFIG.allowedFileTypes.includes(file.type)) {
            return 'نوع الملف غير مدعوم. يرجى رفع صورة أو ملف PDF';
          }
          
          return null;
        }
      };

      // Form validation
      function validateField(fieldId, value, validator) {
        const errorElement = document.getElementById(`${fieldId}-error`);
        const successElement = document.getElementById(`${fieldId}-success`);
        const inputElement = document.getElementById(fieldId);
        
        const error = validator(value);
        
        if (error) {
          setFieldState(inputElement, errorElement, successElement, 'invalid', error);
          state.validationErrors[fieldId] = error;
          return false;
        } else {
          setFieldState(inputElement, errorElement, successElement, 'valid', 'تم التحقق بنجاح');
          delete state.validationErrors[fieldId];
          return true;
        }
      }

      function setFieldState(input, errorEl, successEl, state, message) {
        input.classList.remove('valid', 'invalid');
        input.classList.add(state);
        
        if (errorEl) {
          errorEl.textContent = state === 'invalid' ? message : '';
          errorEl.style.display = state === 'invalid' ? 'block' : 'none';
        }
        
        if (successEl) {
          successEl.textContent = state === 'valid' ? message : '';
          successEl.style.display = state === 'valid' ? 'block' : 'none';
        }
      }

      // Progress tracking
      function updateProgress() {
        const totalFields = 6; // Required fields count
        const completedFields = Object.keys(state.formData).filter(key => 
          state.formData[key] && !state.validationErrors[key]
        ).length;
        
        const progress = Math.min((completedFields / totalFields) * 100, 100);
        const progressFill = document.getElementById('progress-fill');
        if (progressFill) {
          progressFill.style.width = `${progress}%`;
        }
      }

      // Date constraints setup
      function setupDateConstraints() {
        const dateInput = document.getElementById('date');
        if (!dateInput) return;
        
        const today = new Date();
        const minDate = new Date(today);
        minDate.setDate(today.getDate() + 1); // Tomorrow
        
        const maxDate = new Date(today);
        maxDate.setMonth(today.getMonth() + 2); // 2 months from now
        
        dateInput.setAttribute('min', minDate.toISOString().split('T')[0]);
        dateInput.setAttribute('max', maxDate.toISOString().split('T')[0]);
      }

      // File upload handling
      function setupFileHandling() {
        const fileInputs = document.querySelectorAll('input[type="file"]');
        
        fileInputs.forEach(input => {
          input.addEventListener('change', handleFileChange);
          input.addEventListener('dragover', handleDragOver);
          input.addEventListener('drop', handleFileDrop);
        });
      }

      function handleFileChange(event) {
        const input = event.target;
        const file = input.files[0];
        const fileBox = input.closest('.file-box');
        const label = fileBox.querySelector('label');
        const progressBar = fileBox.querySelector('.file-progress');
        
        if (file) {
          const error = validators.file(file);
          if (error) {
            showMessage(error, 'error');
            input.value = '';
            return;
          }
          
          fileBox.classList.add('has-file');
          const fileName = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
          const originalText = label.textContent.split('\n')[0];
          label.innerHTML = label.innerHTML.replace(originalText, `✓ ${fileName}`);
          
          // Simulate upload progress
          let progress = 0;
          const interval = setInterval(() => {
            progress += Math.random() * 30;
            if (progress >= 100) {
              progress = 100;
              clearInterval(interval);
            }
            progressBar.style.width = `${progress}%`;
          }, 100);
          
        } else {
          fileBox.classList.remove('has-file');
          progressBar.style.width = '0%';
        }
      }

      function handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.closest('.file-box').style.borderColor = '#007BFF';
      }

      function handleFileDrop(event) {
        event.preventDefault();
        const fileBox = event.currentTarget.closest('.file-box');
        const input = fileBox.querySelector('input[type="file"]');
        
        fileBox.style.borderColor = '';
        
        if (event.dataTransfer.files.length > 0) {
          input.files = event.dataTransfer.files;
          handleFileChange({ target: input });
        }
      }

      // Choice button functionality
      function setupChoiceButtons() {
        setupSingleChoice('insurance-buttons', 'insurance');
        setupSingleChoice('branch-buttons', 'branch');
        setupSingleChoice('shift-buttons', 'shift');
        setupMultiChoice('time-buttons', 'selected-time');
      }

      function setupSingleChoice(groupId, hiddenId) {
        const buttons = document.querySelectorAll(`#${groupId} .choice-button`);
        const input = document.getElementById(hiddenId);
        
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            // Update ARIA states
            buttons.forEach(b => {
              b.classList.remove('active');
              b.setAttribute('aria-checked', 'false');
            });
            
            btn.classList.add('active');
            btn.setAttribute('aria-checked', 'true');
            input.value = btn.dataset.value;
            
            // Trigger validation
            state.formData[hiddenId] = btn.dataset.value;
            updateProgress();
            
            // Special handling for shift selection
            if (hiddenId === 'shift') {
              handleShiftChange(btn.dataset.value);
            }
          });
          
          // Keyboard support
          btn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              btn.click();
            }
          });
        });
      }

      function setupMultiChoice(groupId, hiddenId) {
        const buttons = document.querySelectorAll(`#${groupId} .choice-button`);
        const input = document.getElementById(hiddenId);
        const selected = new Set();
        
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const value = btn.dataset.value;
            btn.classList.toggle('active');
            
            if (selected.has(value)) {
              selected.delete(value);
            } else {
              selected.add(value);
            }
            
            input.value = Array.from(selected).join(', ');
            state.formData[hiddenId] = input.value;
          });
        });
      }

      function handleShiftChange(shiftValue) {
        const eveningOptions = document.getElementById('evening-options');
        const doctorsInput = document.getElementById('doctors');
        const timeInput = document.getElementById('selected-time');
        
        if (shiftValue === 'مسائي') {
          eveningOptions.style.display = 'block';
          eveningOptions.setAttribute('aria-hidden', 'false');
        } else {
          eveningOptions.style.display = 'none';
          eveningOptions.setAttribute('aria-hidden', 'true');
          
          // Clear evening selections
          doctorsInput.value = '';
          timeInput.value = '';
          document.querySelectorAll('#time-buttons .choice-button').forEach(b => {
            b.classList.remove('active');
          });
        }
      }

      // Input validation setup
      function setupInputValidation() {
        const validationRules = {
          'name': validators.name,
          'phone': validators.phone,
          'alt-phone': validators.altPhone,
          'date': validators.date
        };

        Object.entries(validationRules).forEach(([fieldId, validator]) => {
          const input = document.getElementById(fieldId);
          if (!input) return;

          const debouncedValidation = utils.debounce((value) => {
            validateField(fieldId, value, validator);
            state.formData[fieldId] = value;
            updateProgress();
          }, CONFIG.debounceDelay);

          input.addEventListener('input', (e) => {
            debouncedValidation(e.target.value);
          });

          input.addEventListener('blur', (e) => {
            validateField(fieldId, e.target.value, validator);
          });
        });

        // Character counter for notes
        const notesInput = document.getElementById('notes');
        const notesCounter = document.getElementById('notes-counter');
        if (notesInput && notesCounter) {
          notesInput.addEventListener('input', (e) => {
            const length = e.target.value.length;
            notesCounter.textContent = `${length}/500 حرف`;
            if (length > 450) {
              notesCounter.style.color = 'var(--warning-color)';
            } else {
              notesCounter.style.color = '';
            }
          });
        }
      }

      // Loading state management
      function setLoadingState(isLoading, message = 'جارٍ المعالجة...') {
        const btn = document.getElementById('submit-btn');
        const overlay = document.getElementById('loading-overlay');
        
        state.isSubmitting = isLoading;
        
        if (btn) {
          btn.disabled = isLoading;
          if (isLoading) {
            btn.innerHTML = `${message} <span class="spinner"></span>`;
          } else {
            btn.innerHTML = 'تأكيد و إرسال الحجز';
          }
        }
        
        if (overlay) {
          overlay.style.display = isLoading ? 'flex' : 'none';
          overlay.setAttribute('aria-hidden', !isLoading);
        }
      }

      // File upload to Firebase
      async function uploadFile(file, path) {
        if (!file || !storage) return null;
        
        try {
          const ref = storage.ref(path);
          const uploadTask = ref.put(file);
          
          return new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                // Update progress if needed
              },
              (error) => {
                console.error('Upload error:', error);
                reject(error);
              },
              async () => {
                try {
                  const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                  resolve(downloadURL);
                } catch (error) {
                  reject(error);
                }
              }
            );
          });
        } catch (error) {
          console.error('File upload failed:', error);
          throw new Error(`فشل في رفع الملف: ${error.message}`);
        }
      }

      // Form submission
      async function handleFormSubmission(event) {
        event.preventDefault();
        
        if (state.isSubmitting) return;
        
        try {
          setLoadingState(true, 'جارٍ التحقق من البيانات...');
          
          // Collect and validate all form data
          const formData = collectFormData();
          const validationResult = validateFormData(formData);
          
          if (!validationResult.isValid) {
            showMessage('يرجى تصحيح الأخطاء المذكورة أعلاه', 'error');
            setLoadingState(false);
            return;
          }
          
          // Upload files
          setLoadingState(true, 'جارٍ رفع الملفات...');
          const uploadedFiles = await uploadFiles(formData);
          
          // Save to database
          setLoadingState(true, 'جارٍ حفظ البيانات...');
          const bookingData = {
            ...formData,
            files: uploadedFiles,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'pending',
            id: utils.generateUniqueId()
          };
          
          await utils.retry(async () => {
            await db.collection('bookings').add(bookingData);
          });
          
          // Send WhatsApp confirmation
          sendWhatsAppConfirmation(formData);
          
          // Success feedback
          showMessage('✅ تم إرسال الحجز بنجاح! سيتم التواصل معكم للتأكيد', 'success', 8000);
          
          // Reset form
          resetForm();
          
        } catch (error) {
          console.error('Submission error:', error);
          showMessage(`حدث خطأ: ${error.message || 'يرجى المحاولة مرة أخرى'}`, 'error');
        } finally {
          setLoadingState(false);
        }
      }

      function collectFormData() {
        return {
          name: utils.sanitizeInput(document.getElementById('name').value),
          phone: utils.sanitizeInput(document.getElementById('phone').value),
          altPhone: utils.sanitizeInput(document.getElementById('alt-phone').value),
          insurance: document.getElementById('insurance').value,
          branch: document.getElementById('branch').value,
          date: document.getElementById('date').value,
          shift: document.getElementById('shift').value,
          doctors: utils.sanitizeInput(document.getElementById('doctors').value),
          selectedTime: document.getElementById('selected-time').value,
          notes: utils.sanitizeInput(document.getElementById('notes').value),
          files: {
            carnet: document.getElementById('file-carnet').files[0],
            id: document.getElementById('file-id').files[0],
            prescription: document.getElementById('file-prescription').files[0],
            approval: document.getElementById('file-approval').files[0],
            xray1: document.getElementById('file-xray1').files[0],
            medical: document.getElementById('file-medical').files[0],
            other: document.getElementById('file-other').files[0]
          }
        };
      }

      function validateFormData(data) {
        const errors = [];
        
        // Required field validation
        if (!validators.name(data.name)) errors.push('الاسم');
        if (!validators.phone(data.phone)) errors.push('رقم الهاتف');
        if (!data.insurance) errors.push('شركة التأمين');
        if (!data.branch) errors.push('الفرع');
        if (!validators.date(data.date)) errors.push('التاريخ');
        if (!data.shift) errors.push('الشيفت');
        
        // Evening shift validation
        if (data.shift === 'مسائي') {
          if (!data.doctors) errors.push('اسم الدكتور');
          if (!data.selectedTime) errors.push('الموعد');
        }
        
        // File validation
        Object.values(data.files).forEach(file => {
          if (file) {
            const fileError = validators.file(file);
            if (fileError) errors.push(fileError);
          }
        });
        
        return {
          isValid: errors.length === 0,
          errors
        };
      }

      async function uploadFiles(formData) {
        const uploadedFiles = {};
        const uploadPromises = [];
        
        Object.entries(formData.files).forEach(([key, file]) => {
          if (file) {
            const uniqueId = `${formData.name.replace(/\s/g, '_')}_${Date.now()}`;
            const path = `bookings/${uniqueId}/${key}_${file.name}`;
            uploadPromises.push(
              uploadFile(file, path).then(url => {
                if (url) uploadedFiles[key] = url;
              })
            );
          }
        });
        
        await Promise.all(uploadPromises);
        return uploadedFiles;
      }

      function sendWhatsAppConfirmation(data) {
        try {
          const message = `تم استلام طلب حجز جلستكم في PhysioCare بنجاح ✅

الاسم: ${data.name}
الفرع: ${data.branch}
التاريخ: ${data.date}
الشيفت: ${data.shift}
${data.shift === 'مسائي' ? `الدكتور: ${data.doctors}\nالموعد: ${data.selectedTime}` : ''}

سوف يتم التواصل معكم للتأكيد النهائي.

شكراً لثقتكم في PhysioCare 🏥`;

          const cleanPhone = data.phone.replace(/^0/, '');
          if (cleanPhone.length === 10) {
            const whatsappUrl = `https://wa.me/2${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
          }
        } catch (error) {
          console.error('WhatsApp error:', error);
          // Don't show error to user as this is not critical
        }
      }

      function resetForm() {
        const form = document.getElementById('booking-form');
        if (form) {
          form.reset();
        }
        
        // Reset choice buttons
        document.querySelectorAll('.choice-button.active').forEach(btn => {
          btn.classList.remove('active');
          btn.setAttribute('aria-checked', 'false');
        });
        
        // Reset file boxes
        document.querySelectorAll('.file-box.has-file').forEach(box => {
          box.classList.remove('has-file');
          const progress = box.querySelector('.file-progress');
          if (progress) progress.style.width = '0%';
        });
        
        // Reset validation states
        document.querySelectorAll('input.valid, input.invalid').forEach(input => {
          input.classList.remove('valid', 'invalid');
        });
        
        document.querySelectorAll('.error-message, .success-message').forEach(msg => {
          msg.style.display = 'none';
        });
        
        // Hide evening options
        const eveningOptions = document.getElementById('evening-options');
        if (eveningOptions) {
          eveningOptions.style.display = 'none';
        }
        
        // Reset progress
        const progressFill = document.getElementById('progress-fill');
        if (progressFill) {
          progressFill.style.width = '0%';
        }
        
        // Reset state
        state.formData = {};
        state.validationErrors = {};
      }

      // Keyboard navigation
      function setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
          // Escape key to close messages
          if (e.key === 'Escape') {
            document.querySelectorAll('.message').forEach(msg => msg.remove());
          }
          
          // Enter key on choice buttons
          if (e.key === 'Enter' && e.target.classList.contains('choice-button')) {
            e.preventDefault();
            e.target.click();
          }
        });
      }

      // Error boundary
      function setupErrorHandling() {
        window.addEventListener('error', (event) => {
          console.error('Global error:', event.error);
          showMessage('حدث خطأ غير متوقع. يرجى إعادة تحميل الصفحة.', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
          console.error('Unhandled promise rejection:', event.reason);
          showMessage('حدث خطأ في النظام. يرجى المحاولة مرة أخرى.', 'error');
        });
      }

      // Performance monitoring
      function setupPerformanceMonitoring() {
        if ('performance' in window) {
          window.addEventListener('load', () => {
            const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
            console.log(`Page load time: ${loadTime}ms`);
            
            if (loadTime > 3000) {
              console.warn('Slow page load detected');
            }
          });
        }
      }

      // Initialize everything when DOM is ready
      function initialize() {
        try {
          setupDateConstraints();
          setupFileHandling();
          setupChoiceButtons();
          setupInputValidation();
          setupKeyboardNavigation();
          setupErrorHandling();
          setupPerformanceMonitoring();
          
          // Form submission
          const form = document.getElementById('booking-form');
          if (form) {
            form.addEventListener('submit', handleFormSubmission);
          }
          
          // Welcome message
          setTimeout(() => {
            showMessage('مرحباً بكم في PhysioCare! املأ النموذج لحجز جلستك', 'info');
          }, 1000);
          
          console.log('Application initialized successfully');
          
        } catch (error) {
          console.error('Initialization error:', error);
          showMessage('حدث خطأ في تحميل النظام. يرجى إعادة تحميل الصفحة.', 'error');
        }
      }

      // Start the application
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
      } else {
        initialize();
      }

    })();
  </script>
</body>
</html>
